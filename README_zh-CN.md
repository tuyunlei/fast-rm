# fast-rm

[![Rust](https://img.shields.io/badge/rust-1.70%2B-orange.svg)](https://www.rust-lang.org/)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)

高性能并发文件和目录删除工具，使用 Rust 编写。

[English](./README.md)

## 特性

- **双线程池架构** - 独立的扫描器和删除器线程池，实现最大吞吐量
- **无锁设计** - 原子计数器和 crossbeam 通道，消除互斥锁竞争
- **实时进度** - 精美的 TUI 界面，实时显示进度、删除速度和队列深度
- **默认安全** - 路径重叠检测、符号链接处理和预演模式
- **精细控制** - 可独立调整扫描器和删除器的线程数
- **错误恢复** - 继续执行模式，优雅处理错误

## 安装

### 从源码编译

```bash
git clone https://github.com/yourusername/fast-rm.git
cd fast-rm
cargo build --release
```

编译后的二进制文件位于 `target/release/fast-rm`。

## 使用方法

```bash
# 基本用法
fast-rm <路径>...

# 预演模式（显示将要删除的内容）
fast-rm -n <路径>

# 详细输出（-v 标准模式，-vv 详细模式）
fast-rm -v <路径>

# 设置两个线程池的线程数
fast-rm -j 8 <路径>

# 精细线程控制
fast-rm --scan-threads 4 --delete-threads 8 <路径>

# 遇错继续
fast-rm -c <路径>

# 组合选项
fast-rm -v -n -c <路径>
```

## 选项

| 选项 | 简写 | 描述 |
|------|------|------|
| `--verbose` | `-v` | 增加详细程度（-v：标准，-vv：详细）|
| `--dry-run` | `-n` | 显示将要删除的内容，但不执行删除 |
| `--threads` | `-j` | 两个线程池的线程数（默认：CPU 核心数）|
| `--scan-threads` | | 扫描器线程数（覆盖 -j）|
| `--delete-threads` | | 删除器线程数（覆盖 -j）|
| `--continue-on-error` | `-c` | 遇到错误后继续处理 |

## 架构

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   扫描器线程池    │────▶│    自适应队列     │────▶│   删除器线程池    │
│  (Rayon 实现)   │     │    (无锁设计)     │     │   (工作线程)     │
└─────────────────┘     └──────────────────┘     └─────────────────┘
        │                        │                        │
        ▼                        ▼                        ▼
    并行深度优先              MPMC 通道                并发删除
      遍历                  带背压控制
```

### 为什么使用双线程池？

1. **精确进度** - 扫描先完成，提供准确的项目总数
2. **最大吞吐** - 扫描器和删除器同时工作
3. **独立调优** - 根据 I/O 和 CPU 特性分别优化
4. **队列可视** - 实时队列深度展示管道健康状态

## 性能

### fast-rm vs rm -r

| 文件数 | fast-rm | rm -r | 比例 |
|--------|---------|-------|------|
| 100 | 170ms | 19ms | 0.11x |
| 500 | 192ms | 55ms | 0.29x |
| 1,000 | 220ms | 97ms | 0.44x |
| 2,000 | 351ms | 160ms | 0.46x |
| 5,000 | 632ms | 250ms | 0.40x |

### 关键发现

- **启动开销**：约 170ms（TUI 初始化、线程池创建）
- **吞吐量扩展**：随文件数增加，从 587 → 7,917 项/秒
- **权衡**：比 `rm -r` 慢，但提供实时进度和安全特性

### 使用建议

| 场景 | 建议 |
|------|------|
| 小目录（< 500 文件）| 使用 `rm -r` |
| 大目录（> 5,000 文件）| fast-rm 提供进度可视化 |
| 需要监控进度 | fast-rm 配合 `-v` |
| 安全关键（生产数据）| fast-rm 配合 `-n`（先预演）|
| 追求极致速度 | 使用 `rm -r` |

详见 [BENCHMARK.md](./BENCHMARK.md) 获取详细性能分析。

## 安全特性

- **路径重叠检测** - 防止并发删除嵌套路径
- **符号链接处理** - 使用 `symlink_metadata()` 避免跟随损坏的符号链接
- **预演模式** - 执行前安全测试删除操作
- **遇错继续** - 处理权限错误而不停止

## 开发

```bash
# 运行测试
cargo test

# 运行代码检查
cargo clippy

# 格式化代码
cargo fmt

# 运行基准测试
cargo bench
```

## 许可证

MIT 许可证 - 详见 [LICENSE](LICENSE)。

## 贡献

欢迎贡献！请随时提交 Pull Request。
